name: ðŸš€ Classic Isekai ì›¹ì†Œì„¤ ê°œì„ 

on:
  workflow_dispatch:
    inputs:
      mission:
        description: 'ë¯¸ì…˜ (ì˜ˆ: 1~3í™” ë°˜ë³µ ê°œì„ )'
        required: true
        default: '1~3í™” ë°˜ë³µ ê°œì„ '
      
      target_score:
        description: 'ëª©í‘œ ì ìˆ˜'
        required: false
        default: '8.5'
      
      create_pr:
        description: 'Pull Request ìƒì„± ì—¬ë¶€'
        required: true
        type: choice
        default: 'false'
        options:
          - 'true'
          - 'false'
  
  # Classic Isekai ì €ìž¥ì†Œì˜ Issue íŠ¸ë¦¬ê±°
  repository_dispatch:
    types: [improve-episode]
  
  schedule:
    - cron: '0 0 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ ìžì •

jobs:
  improve-classic-isekai:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    
    steps:
    - name: Checkout AI Workflow
      uses: actions/checkout@v3
      with:
        path: ai-workflow
    
    - name: Checkout Classic Isekai
      uses: actions/checkout@v3
      with:
        repository: garimto81/classic-isekai
        token: ${{ secrets.GITHUB_TOKEN }}
        path: classic-isekai
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r ai-workflow/src/workflow/requirements.txt
    
    - name: Parse mission and validate episodes
      id: parse-and-validate
      run: |
        cat > validate_and_parse.py << 'EOF'
        import sys
        import json
        import asyncio
        sys.path.append('ai-workflow/src/workflow')
        
        from text_mission_parser import MissionExecutor
        from repository_connector import ClassicIsekaiConnector, EpisodeValidator
        
        async def validate_and_parse():
            # ë¯¸ì…˜ íŒŒì‹±
            mission_text = """${{ github.event.inputs.mission }}"""
            executor = MissionExecutor()
            config = executor.execute_text_mission(mission_text)
            
            print("ðŸ“ ë¯¸ì…˜ íŒŒì‹± ì™„ë£Œ:")
            print(f"   ëŒ€ìƒ: {config['target_episodes']}í™”")
            print(f"   ì•¡ì…˜: {config['action']}")
            
            # Classic Isekai ì €ìž¥ì†Œ ì—°ê²°
            connector = ClassicIsekaiConnector()
            
            # ì—í”¼ì†Œë“œ ê²€ì¦
            validator = EpisodeValidator(connector)
            validation_results = []
            
            for episode_num in config['target_episodes']:
                print(f"\nðŸ” {episode_num}í™” ê²€ì¦ ì¤‘...")
                result = await validator.validate_episode(episode_num)
                validation_results.append(result)
                
                if result['valid']:
                    print(f"   âœ… ìœ íš¨í•¨")
                else:
                    print(f"   âŒ ë¬¸ì œ ë°œê²¬: {result}")
            
            # í”„ë¡œì íŠ¸ ë¬¸ì„œ ë¡œë“œ
            print("\nðŸ“š í”„ë¡œì íŠ¸ ë¬¸ì„œ ë¡œë“œ ì¤‘...")
            docs = await connector.fetch_project_documents()
            print(f"   {len(docs)}ê°œ ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ")
            
            # ê²°ê³¼ ì €ìž¥
            with open('mission_config.json', 'w') as f:
                json.dump(config, f, indent=2, ensure_ascii=False)
            
            with open('validation_results.json', 'w') as f:
                json.dump(validation_results, f, indent=2, ensure_ascii=False)
            
            # GitHub Actions ì¶œë ¥
            episodes = ','.join(map(str, config['target_episodes']))
            print(f"::set-output name=episodes::{episodes}")
            print(f"::set-output name=max_cycles::{config.get('max_cycles', 10)}")
            
            return config, validation_results
        
        asyncio.run(validate_and_parse())
        EOF
        
        python validate_and_parse.py
    
    - name: Execute improvement
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        cat > improve_episodes.py << 'EOF'
        import sys
        import json
        import asyncio
        from pathlib import Path
        sys.path.append('ai-workflow/src/workflow')
        
        from new_agent_system import NewAgentSystem
        from repository_connector import ClassicIsekaiConnector
        
        async def improve_episodes():
            # ì„¤ì • ë¡œë“œ
            with open('mission_config.json', 'r') as f:
                config = json.load(f)
            
            # Classic Isekai ì—°ê²°
            connector = ClassicIsekaiConnector()
            
            # ê°œì„  ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            system = NewAgentSystem()
            # Classic Isekai ê²½ë¡œë¡œ ì„¤ì •
            system.project_path = Path('classic-isekai')
            await system.initialize()
            
            # ê° ì—í”¼ì†Œë“œ ê°œì„ 
            results = {}
            for episode_num in config['target_episodes']:
                print(f"\nðŸ“– {episode_num}í™” ê°œì„  ì‹œìž‘...")
                
                # ì›ë³¸ ë‚´ìš© ë¡œë“œ
                original_content = await connector.fetch_episode_content(episode_num)
                if not original_content:
                    print(f"   âŒ {episode_num}í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ")
                    continue
                
                # ê°œì„  ìž‘ì—…
                task = {
                    'type': 'improve_episode',
                    'episode_number': episode_num,
                    'target_score': float("${{ github.event.inputs.target_score }}"),
                    'content': original_content,
                    'priority_aspects': config.get('priority_aspects', [])
                }
                
                result = await system.main_coordinator.coordinate_episode_improvement(task)
                
                # ê°œì„ ëœ ë‚´ìš© ì €ìž¥
                if result.get('improved_content'):
                    episode_path = Path(f'classic-isekai/webnovel_episodes/{episode_num:03d}_ì—í”¼ì†Œë“œ_{episode_num}í™”.md')
                    with open(episode_path, 'w', encoding='utf-8') as f:
                        f.write(result['improved_content'])
                    print(f"   âœ… {episode_num}í™” ê°œì„  ì™„ë£Œ")
                
                results[f'episode_{episode_num}'] = result
            
            # ê²°ê³¼ ì €ìž¥
            with open('improvement_results.json', 'w') as f:
                json.dump(results, f, indent=2, ensure_ascii=False)
            
            return results
        
        asyncio.run(improve_episodes())
        EOF
        
        python improve_episodes.py
    
    - name: Create Pull Request or Commit
      run: |
        cd classic-isekai
        
        # Git ì„¤ì •
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸
        if git diff --quiet; then
          echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          exit 0
        fi
        
        # PR ìƒì„± ì—¬ë¶€ì— ë”°ë¼ ì²˜ë¦¬
        if [ "${{ github.event.inputs.create_pr }}" = "true" ]; then
          # ë¸Œëžœì¹˜ ìƒì„±
          BRANCH_NAME="improve-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # ì»¤ë°‹
          git add webnovel_episodes/*.md
          git commit -m "ðŸ¤– AI ê°œì„ : ${{ github.event.inputs.mission }}"
          
          # í‘¸ì‹œ
          git push origin $BRANCH_NAME
          
          # PR ìƒì„±
          gh pr create \
            --title "ðŸ¤– AI ê°œì„ : ${{ github.event.inputs.mission }}" \
            --body "## ðŸ“ ê°œì„  ë‚´ìš©\n\në¯¸ì…˜: ${{ github.event.inputs.mission }}\nëª©í‘œ ì ìˆ˜: ${{ github.event.inputs.target_score }}\n\n[ìƒì„¸ ê²°ê³¼](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            --base master \
            --head $BRANCH_NAME
        else
          # ì§ì ‘ ì»¤ë°‹
          git add webnovel_episodes/*.md
          git commit -m "ðŸ¤– AI ê°œì„ : ${{ github.event.inputs.mission }}"
          git push
        fi
    
    - name: Create summary
      run: |
        echo "## ðŸŽ¯ Classic Isekai ê°œì„  ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ë¯¸ì…˜" >> $GITHUB_STEP_SUMMARY
        echo "${{ github.event.inputs.mission }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        
        if [ -f improvement_results.json ]; then
          python -c "
          import json
          with open('improvement_results.json') as f:
              data = json.load(f)
              for ep, result in data.items():
                  score = result.get('final_score', 0)
                  improvements = len(result.get('improvements_made', []))
                  print(f\"- {ep}: {score:.1f}ì , {improvements}ê°œ ê°œì„ \")
          " >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ì €ìž¥ì†Œ" >> $GITHUB_STEP_SUMMARY
        echo "[Classic Isekai](https://github.com/garimto81/classic-isekai)" >> $GITHUB_STEP_SUMMARY