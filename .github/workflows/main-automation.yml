name: ðŸš€ ì›¹ì†Œì„¤ ìžë™í™” ì‹œìŠ¤í…œ

on:
  # 1. ìˆ˜ë™ ì‹¤í–‰ - ëª¨ë“  ì˜µì…˜ ì§€ì›
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: true
        type: choice
        default: 'text'
        options:
          - text        # í…ìŠ¤íŠ¸ ë¯¸ì…˜ (ì˜ˆ: "1~3í™” ë°˜ë³µ ê°œì„ ")
          - continuous  # ì—°ì† ì‹¤í–‰ (ëª©í‘œ ë‹¬ì„±ê¹Œì§€)
          - single      # ë‹¨ì¼ ì‚¬ì´í´
          - preset      # í”„ë¦¬ì…‹ ë¯¸ì…˜
      
      mission:
        description: 'ë¯¸ì…˜ ìž…ë ¥ (text ëª¨ë“œ) ë˜ëŠ” í”„ë¦¬ì…‹ ì„ íƒ'
        required: false
        default: '1~3í™” ë°˜ë³µ ê°œì„ '
      
      episodes:
        description: 'ì—í”¼ì†Œë“œ (single/continuous ëª¨ë“œìš©)'
        required: false
        default: '1,2,3'
      
      target_score:
        description: 'ëª©í‘œ ì ìˆ˜'
        required: false
        default: '8.5'
      
      max_cycles:
        description: 'ìµœëŒ€ ì‚¬ì´í´'
        required: false
        default: '10'
  
  # 2. ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ìžë™)
  schedule:
    - cron: '0 */6 * * *'  # 6ì‹œê°„ë§ˆë‹¤
  
  # 3. Issue íŠ¸ë¦¬ê±°
  issues:
    types: [opened, edited]
  
  # 4. Issue ëŒ“ê¸€ íŠ¸ë¦¬ê±°
  issue_comment:
    types: [created]
  
  # 5. ì—°ì† ì‹¤í–‰ íŠ¸ë¦¬ê±°
  repository_dispatch:
    types: [continue-automation]

jobs:
  # ìžë™ ëª¨ë‹ˆí„°ë§ (í•­ìƒ ì‹¤í–‰)
  monitor:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
    - uses: actions/checkout@v3
    
    - name: Check automation health
      run: |
        echo "ðŸ” ìžë™í™” ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬"
        if [ -f "cycle_state.json" ]; then
          echo "ìµœê·¼ ì‹¤í–‰ í™•ì¸"
          # 6ì‹œê°„ ì´ìƒ ì¤‘ë‹¨ë˜ì—ˆìœ¼ë©´ ìž¬ì‹œìž‘
          # ... ëª¨ë‹ˆí„°ë§ ë¡œì§
        fi
  
  # ë©”ì¸ ì‹¤í–‰ Job
  execute:
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    timeout-minutes: 350
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/workflow/requirements.txt
    
    - name: Determine execution mode
      id: determine-mode
      run: |
        # ì‹¤í–‰ ëª¨ë“œ ê²°ì •
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MODE="${{ github.event.inputs.mode }}"
          MISSION="${{ github.event.inputs.mission }}"
        elif [ "${{ github.event_name }}" = "issues" ]; then
          MODE="text"
          MISSION=$(echo "${{ github.event.issue.body }}" | head -n 1)
        elif [ "${{ github.event_name }}" = "issue_comment" ]; then
          if [[ "${{ github.event.comment.body }}" == /mission* ]]; then
            MODE="text"
            MISSION=$(echo "${{ github.event.comment.body }}" | sed 's/^\/mission //')
          fi
        elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          MODE="continuous"
        else
          MODE="text"
          MISSION="1~3í™” ë°˜ë³µ ê°œì„ "
        fi
        
        echo "mode=$MODE" >> $GITHUB_OUTPUT
        echo "mission=$MISSION" >> $GITHUB_OUTPUT
        
        echo "ðŸ“‹ ì‹¤í–‰ ëª¨ë“œ: $MODE"
        echo "ðŸ“ ë¯¸ì…˜/ì„¤ì •: $MISSION"
    
    - name: Parse and execute mission
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        cat > unified_executor.py << 'EOF'
        import sys
        import json
        import asyncio
        sys.path.append('src/workflow')
        
        from new_agent_system import NewAgentSystem
        from text_mission_parser import MissionExecutor
        from mission_config import MissionManager, MissionLibrary
        
        mode = "${{ steps.determine-mode.outputs.mode }}"
        mission_input = """${{ steps.determine-mode.outputs.mission }}"""
        
        async def run_unified_mission():
            print(f"ðŸš€ í†µí•© ì‹¤í–‰ ì‹œìŠ¤í…œ")
            print(f"   ëª¨ë“œ: {mode}")
            print(f"   ìž…ë ¥: {mission_input}")
            
            # ëª¨ë“œë³„ ì„¤ì • íŒŒì‹±
            if mode == "text":
                # í…ìŠ¤íŠ¸ ë¯¸ì…˜ íŒŒì‹±
                executor = MissionExecutor()
                config = executor.execute_text_mission(mission_input)
                episodes = config['target_episodes']
                target_score = config.get('success_criteria', {}).get('min_score', 8.0)
                max_cycles = config.get('max_cycles', 10)
                
            elif mode == "preset":
                # í”„ë¦¬ì…‹ ë¯¸ì…˜ ë¡œë“œ
                manager = MissionManager()
                mission = manager.load_mission(mission_input)
                episodes = mission.target_episodes
                target_score = mission.success_criteria.get('min_score', 8.0)
                max_cycles = mission.max_cycles
                
            elif mode in ["continuous", "single"]:
                # ì§ì ‘ ì„¤ì •
                episodes = [int(x) for x in "${{ github.event.inputs.episodes }}".split(',')]
                target_score = float("${{ github.event.inputs.target_score }}")
                max_cycles = int("${{ github.event.inputs.max_cycles }}")
                if mode == "single":
                    max_cycles = 1
            
            else:
                # ê¸°ë³¸ê°’
                episodes = [1, 2, 3]
                target_score = 8.0
                max_cycles = 10
            
            # ì‹œìŠ¤í…œ ì‹¤í–‰
            system = NewAgentSystem()
            await system.initialize()
            
            # ë¯¸ì…˜ ì‹¤í–‰
            for cycle in range(1, max_cycles + 1):
                print(f"\nðŸ”„ ì‚¬ì´í´ #{cycle}/{max_cycles}")
                
                all_success = True
                for episode in episodes:
                    task = {
                        'type': 'improve_episode',
                        'episode_number': episode,
                        'target_score': target_score
                    }
                    
                    result = await system.main_coordinator.coordinate_episode_improvement(task)
                    
                    if result.get('final_score', 0) < target_score:
                        all_success = False
                
                if all_success:
                    print(f"âœ… ëª©í‘œ ë‹¬ì„±!")
                    break
                
                # ì—°ì† ëª¨ë“œì´ê³  ì‚¬ì´í´ì´ ëë‚¬ìœ¼ë©´ ë‹¤ìŒ íŠ¸ë¦¬ê±°
                if mode == "continuous" and cycle == max_cycles:
                    print("ðŸ”„ ë‹¤ìŒ ì‚¬ì´í´ íŠ¸ë¦¬ê±°...")
                    # repository_dispatch ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
            
            return True
        
        asyncio.run(run_unified_mission())
        EOF
        
        python unified_executor.py
    
    - name: Create summary
      run: |
        echo "## ðŸŽ¯ ì‹¤í–‰ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ëª¨ë“œ**: ${{ steps.determine-mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¯¸ì…˜**: ${{ steps.determine-mode.outputs.mission }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
    
    - name: Commit results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --staged --quiet || git commit -m "Auto: ${{ steps.determine-mode.outputs.mode }} - ${{ steps.determine-mode.outputs.mission }}"
        git push
    
    - name: Trigger next cycle (if continuous)
      if: steps.determine-mode.outputs.mode == 'continuous'
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        event-type: continue-automation