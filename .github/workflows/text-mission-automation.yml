name: Text Mission Automation

on:
  workflow_dispatch:
    inputs:
      mission_text:
        description: 'ë¯¸ì…˜ì„ í…ìŠ¤íŠ¸ë¡œ ì…ë ¥ (ì˜ˆ: 1~3í™” ë°˜ë³µ ê°œì„ )'
        required: true
        default: '1~3í™” ë°˜ë³µ ê°œì„ '
      
  issues:
    types: [opened, edited]
  
  issue_comment:
    types: [created]

jobs:
  parse-and-execute:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'mission')) ||
      (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/mission'))
    
    timeout-minutes: 350
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/workflow/requirements.txt
    
    - name: Extract mission text
      id: extract-mission
      run: |
        # ë¯¸ì…˜ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MISSION_TEXT="${{ github.event.inputs.mission_text }}"
        elif [ "${{ github.event_name }}" = "issues" ]; then
          # Issue ë³¸ë¬¸ì—ì„œ ë¯¸ì…˜ ì¶”ì¶œ
          MISSION_TEXT=$(echo "${{ github.event.issue.body }}" | head -n 1)
        elif [ "${{ github.event_name }}" = "issue_comment" ]; then
          # ì½”ë©˜íŠ¸ì—ì„œ /mission ì´í›„ í…ìŠ¤íŠ¸ ì¶”ì¶œ
          MISSION_TEXT=$(echo "${{ github.event.comment.body }}" | sed 's/^\/mission //')
        fi
        
        echo "mission_text=$MISSION_TEXT" >> $GITHUB_OUTPUT
        echo "ğŸ“ ë¯¸ì…˜: $MISSION_TEXT"
    
    - name: Parse mission
      id: parse-mission
      run: |
        cat > parse_mission.py << 'EOF'
        import sys
        import json
        sys.path.append('src/workflow')
        
        from text_mission_parser import MissionExecutor
        
        mission_text = """${{ steps.extract-mission.outputs.mission_text }}"""
        
        executor = MissionExecutor()
        config = executor.execute_text_mission(mission_text)
        
        # GitHub Actions ì¶œë ¥ ì„¤ì •
        with open('mission_config.json', 'w') as f:
            json.dump(config, f, indent=2, ensure_ascii=False)
        
        # ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
        episodes = ','.join(map(str, config['target_episodes']))
        max_cycles = config.get('max_cycles', 10)
        
        print(f"::set-output name=episodes::{episodes}")
        print(f"::set-output name=max_cycles::{max_cycles}")
        print(f"::set-output name=action::{config.get('action', 'improve')}")
        
        # ìƒì„¸ ì •ë³´ ì¶œë ¥
        print("\nğŸ“‹ íŒŒì‹±ëœ ë¯¸ì…˜ ì„¤ì •:")
        print(json.dumps(config, indent=2, ensure_ascii=False))
        EOF
        
        python parse_mission.py
    
    - name: Execute mission
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        cat > execute_text_mission.py << 'EOF'
        import sys
        import json
        import asyncio
        sys.path.append('src/workflow')
        
        from new_agent_system import NewAgentSystem
        from text_mission_parser import TextMissionParser
        
        async def run_text_mission():
            # ë¯¸ì…˜ ì„¤ì • ë¡œë“œ
            with open('mission_config.json', 'r') as f:
                config = json.load(f)
            
            print(f"ğŸ¯ í…ìŠ¤íŠ¸ ë¯¸ì…˜ ì‹¤í–‰")
            print(f"   ì›ë¬¸: {config['description']}")
            print(f"   ëŒ€ìƒ: {config['target_episodes']}í™”")
            print(f"   ì•¡ì…˜: {config['action']}")
            print(f"   ìµœëŒ€ ì‚¬ì´í´: {config['max_cycles']}")
            
            # ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            system = NewAgentSystem()
            await system.initialize()
            
            # ë¯¸ì…˜ ì‹¤í–‰
            results = {}
            for cycle in range(1, config['max_cycles'] + 1):
                print(f"\nğŸ”„ ì‚¬ì´í´ #{cycle}/{config['max_cycles']}")
                
                cycle_results = {}
                for episode in config['target_episodes']:
                    task = {
                        'type': 'improve_episode',
                        'episode_number': episode,
                        'target_score': config.get('success_criteria', {}).get('min_score', 8.0),
                        'priority_aspects': config.get('priority_aspects', [])
                    }
                    
                    result = await system.main_coordinator.coordinate_episode_improvement(task)
                    cycle_results[f'episode_{episode}'] = result
                
                # ì„±ê³µ ì²´í¬
                success = True
                if 'success_criteria' in config:
                    for criterion, value in config['success_criteria'].items():
                        if 'score' in criterion:
                            # ì ìˆ˜ ê¸°ì¤€ ì²´í¬
                            for ep_result in cycle_results.values():
                                if ep_result.get('final_score', 0) < value:
                                    success = False
                
                if success:
                    print(f"âœ… ë¯¸ì…˜ ì„±ê³µ!")
                    break
            
            # ìµœì¢… ê²°ê³¼ ì €ì¥
            with open('mission_results.json', 'w') as f:
                json.dump({
                    'mission': config['description'],
                    'cycles_used': cycle,
                    'results': cycle_results
                }, f, indent=2, ensure_ascii=False)
            
            return results
        
        asyncio.run(run_text_mission())
        EOF
        
        python execute_text_mission.py
    
    - name: Create report
      run: |
        echo "## ğŸ“ í…ìŠ¤íŠ¸ ë¯¸ì…˜ ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ë¯¸ì…˜" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.extract-mission.outputs.mission_text }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### í•´ì„" >> $GITHUB_STEP_SUMMARY
        echo "- ì—í”¼ì†Œë“œ: ${{ steps.parse-mission.outputs.episodes }}" >> $GITHUB_STEP_SUMMARY
        echo "- ì•¡ì…˜: ${{ steps.parse-mission.outputs.action }}" >> $GITHUB_STEP_SUMMARY
        echo "- ìµœëŒ€ ì‚¬ì´í´: ${{ steps.parse-mission.outputs.max_cycles }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f mission_results.json ]; then
          echo "### ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          python -c "
          import json
          with open('mission_results.json') as f:
              data = json.load(f)
              print(f\"- ì‚¬ìš©ëœ ì‚¬ì´í´: {data.get('cycles_used', 'N/A')}\")
          " >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Update issue (if triggered by issue)
      if: github.event_name == 'issues' || github.event_name == 'issue_comment'
      uses: actions/github-script@v6
      with:
        script: |
          const issue_number = context.issue.number;
          
          // ê²°ê³¼ ì½ê¸°
          const fs = require('fs');
          let results = {};
          if (fs.existsSync('mission_results.json')) {
            results = JSON.parse(fs.readFileSync('mission_results.json', 'utf8'));
          }
          
          // ì½”ë©˜íŠ¸ ì‘ì„±
          const comment = `
          ## âœ… ë¯¸ì…˜ ì‹¤í–‰ ì™„ë£Œ
          
          **ë¯¸ì…˜**: ${results.mission || 'N/A'}
          **ì‚¬ì´í´**: ${results.cycles_used || 'N/A'}
          
          [ìƒì„¸ ê²°ê³¼ ë³´ê¸°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issue_number,
            body: comment
          });
    
    - name: Commit results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --staged --quiet || git commit -m "í…ìŠ¤íŠ¸ ë¯¸ì…˜: ${{ steps.extract-mission.outputs.mission_text }}"
        git push